<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVC éŸ³é¢‘å¯è§†åŒ–æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .visualizer-section {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .visualizer-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .audio-visualizer {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .visualizer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .visualizer-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .visualizer-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #f5f5f5;
        }

        .toggle-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .view-mode {
            display: flex;
            gap: 8px;
            font-size: 12px;
        }

        .view-mode label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .level-meter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .level-bar {
            width: 80px;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .level-fill {
            height: 100%;
            transition: width 0.1s ease-out;
            border-radius: 4px;
        }

        .level-value {
            font-family: monospace;
            color: #666;
            min-width: 45px;
            text-align: right;
        }

        .visualization-canvas {
            width: 100%;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .control-btn.primary {
            background: #2196F3;
            color: white;
        }

        .control-btn.primary:hover {
            background: #1976D2;
        }

        .control-btn.secondary {
            background: #f44336;
            color: white;
        }

        .control-btn.secondary:hover {
            background: #d32f2f;
        }

        .status-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-section {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .info-section h4 {
            color: #1976D2;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .visualizer-row {
                grid-template-columns: 1fr;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ RVC éŸ³é¢‘å¯è§†åŒ–</h1>
            <p>å®æ—¶éŸ³é¢‘æ³¢å½¢ä¸é¢‘è°±å¯è§†åŒ–æ¼”ç¤º</p>
        </div>

        <div class="content">
            <!-- éŸ³é¢‘å¯è§†åŒ–åŒºåŸŸ -->
            <div class="visualizer-section">
                <div class="visualizer-row">
                    <!-- è¾“å…¥éŸ³é¢‘å¯è§†åŒ– -->
                    <div class="audio-visualizer">
                        <div class="visualizer-header">
                            <h3>ğŸ“¥ è¾“å…¥éŸ³é¢‘</h3>
                            <div class="visualizer-controls">
                                <button id="inputToggle" class="toggle-btn">å¼€å§‹</button>
                                <div class="view-mode">
                                    <label>
                                        <input type="radio" name="inputView" value="waveform" checked> æ³¢å½¢
                                    </label>
                                    <label>
                                        <input type="radio" name="inputView" value="spectrum"> é¢‘è°±
                                    </label>
                                </div>
                                <div class="level-meter">
                                    <span>éŸ³é‡:</span>
                                    <div class="level-bar">
                                        <div id="inputLevel" class="level-fill" style="width: 0%; background-color: #4CAF50;"></div>
                                    </div>
                                    <span id="inputLevelText" class="level-value">-60.0dB</span>
                                </div>
                            </div>
                        </div>
                        <canvas id="inputCanvas" class="visualization-canvas" width="400" height="120"></canvas>
                    </div>

                    <!-- è¾“å‡ºéŸ³é¢‘å¯è§†åŒ– -->
                    <div class="audio-visualizer">
                        <div class="visualizer-header">
                            <h3>ğŸ“¤ è¾“å‡ºéŸ³é¢‘</h3>
                            <div class="visualizer-controls">
                                <button id="outputToggle" class="toggle-btn">å¼€å§‹</button>
                                <div class="view-mode">
                                    <label>
                                        <input type="radio" name="outputView" value="waveform" checked> æ³¢å½¢
                                    </label>
                                    <label>
                                        <input type="radio" name="outputView" value="spectrum"> é¢‘è°±
                                    </label>
                                </div>
                                <div class="level-meter">
                                    <span>éŸ³é‡:</span>
                                    <div class="level-bar">
                                        <div id="outputLevel" class="level-fill" style="width: 0%; background-color: #4CAF50;"></div>
                                    </div>
                                    <span id="outputLevelText" class="level-value">-60.0dB</span>
                                </div>
                            </div>
                        </div>
                        <canvas id="outputCanvas" class="visualization-canvas" width="400" height="120"></canvas>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls-section">
                <div class="controls-row">
                    <button id="startDemo" class="control-btn primary">ğŸ¬ å¼€å§‹æ¼”ç¤º</button>
                    <button id="stopDemo" class="control-btn secondary">â¹ï¸ åœæ­¢æ¼”ç¤º</button>
                    <div class="status-info">
                        <div class="status-item">
                            <div id="statusIndicator" class="status-indicator"></div>
                            <span id="statusText">å‡†å¤‡å°±ç»ª</span>
                        </div>
                        <div class="status-item">
                            <span>å¤„ç†å»¶è¿Ÿ: <strong id="latencyText">0ms</strong></span>
                        </div>
                        <div class="status-item">
                            <span>å¸§ç‡: <strong id="fpsText">0 FPS</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h4>ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                <ul>
                    <li><strong>å¼€å§‹æ¼”ç¤º</strong>: ç‚¹å‡»"å¼€å§‹æ¼”ç¤º"æŒ‰é’®å¯åŠ¨æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®ç”Ÿæˆ</li>
                    <li><strong>è§†å›¾åˆ‡æ¢</strong>: é€‰æ‹©"æ³¢å½¢"æŸ¥çœ‹æ—¶åŸŸä¿¡å·ï¼Œé€‰æ‹©"é¢‘è°±"æŸ¥çœ‹é¢‘åŸŸåˆ†æ</li>
                    <li><strong>éŸ³é‡ç›‘æ§</strong>: å®æ—¶ç›‘æ§éŸ³é¢‘ä¿¡å·çš„å¼ºåº¦å’Œåˆ†è´çº§åˆ«</li>
                    <li><strong>ç‹¬ç«‹æ§åˆ¶</strong>: æ¯ä¸ªå¯è§†åŒ–çª—å£å¯ä»¥ç‹¬ç«‹å¼€å¯/å…³é—­</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        class AudioVisualizer {
            constructor(canvasId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.isActive = false;
                this.viewMode = 'waveform';
                this.audioBuffer = [];
                this.frequencyData = [];
                this.maxBufferSize = 2048;
                this.animationId = null;

                this.options = {
                    primaryColor: options.primaryColor || '#2196F3',
                    backgroundColor: options.backgroundColor || '#f8f9fa',
                    gridColor: options.gridColor || '#e0e0e0',
                    ...options
                };

                this.setupCanvas();
            }

            setupCanvas() {
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;

                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
            }

            start() {
                if (this.isActive) return;
                this.isActive = true;
                this.animate();
            }

            stop() {
                this.isActive = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            setViewMode(mode) {
                this.viewMode = mode;
            }

            updateAudioData(data) {
                this.audioBuffer = [...data];
                if (this.audioBuffer.length > this.maxBufferSize) {
                    this.audioBuffer = this.audioBuffer.slice(-this.maxBufferSize);
                }

                // è®¡ç®—é¢‘è°±æ•°æ® (ç®€åŒ–ç‰ˆFFT)
                this.calculateFrequencyData();
            }

            calculateFrequencyData() {
                const bins = 32;
                const binSize = Math.floor(this.audioBuffer.length / bins);
                this.frequencyData = [];

                for (let i = 0; i < bins; i++) {
                    const start = i * binSize;
                    const end = Math.min(start + binSize, this.audioBuffer.length);
                    const binSamples = this.audioBuffer.slice(start, end);

                    if (binSamples.length > 0) {
                        const rms = Math.sqrt(
                            binSamples.reduce((sum, sample) => sum + sample * sample, 0) / binSamples.length
                        );
                        this.frequencyData.push(Math.min(1, rms * 2));
                    } else {
                        this.frequencyData.push(0);
                    }
                }
            }

            animate() {
                if (!this.isActive) return;

                this.draw();
                this.animationId = requestAnimationFrame(() => this.animate());
            }

            draw() {
                const width = this.canvas.width / (window.devicePixelRatio || 1);
                const height = this.canvas.height / (window.devicePixelRatio || 1);

                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = this.options.backgroundColor;
                this.ctx.fillRect(0, 0, width, height);

                if (this.viewMode === 'waveform') {
                    this.drawWaveform(width, height);
                } else if (this.viewMode === 'spectrum') {
                    this.drawSpectrum(width, height);
                }
            }

            drawWaveform(width, height) {
                if (this.audioBuffer.length === 0) {
                    this.drawNoSignal(width, height, 'æ— éŸ³é¢‘ä¿¡å·');
                    return;
                }

                // ç»˜åˆ¶ç½‘æ ¼
                this.drawGrid(width, height);

                // ç»˜åˆ¶æ³¢å½¢
                this.ctx.strokeStyle = this.options.primaryColor;
                this.ctx.lineWidth = 1.5;
                this.ctx.beginPath();

                const sliceWidth = width / this.audioBuffer.length;
                let x = 0;

                for (let i = 0; i < this.audioBuffer.length; i++) {
                    const amplitude = this.audioBuffer[i];
                    const y = (amplitude * 0.4 + 0.5) * height;

                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                this.ctx.stroke();

                // ç»˜åˆ¶ä¸­å¿ƒçº¿
                this.ctx.strokeStyle = this.options.gridColor;
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                this.ctx.moveTo(0, height / 2);
                this.ctx.lineTo(width, height / 2);
                this.ctx.stroke();
                this.ctx.setLineDash([]);
            }

            drawSpectrum(width, height) {
                if (this.frequencyData.length === 0) {
                    this.drawNoSignal(width, height, 'æ— é¢‘è°±æ•°æ®');
                    return;
                }

                const barWidth = width / this.frequencyData.length;
                const maxBarHeight = height * 0.8;

                for (let i = 0; i < this.frequencyData.length; i++) {
                    const barHeight = this.frequencyData[i] * maxBarHeight;
                    const x = i * barWidth;
                    const y = height - barHeight;

                    // åˆ›å»ºæ¸å˜
                    const gradient = this.ctx.createLinearGradient(0, y, 0, height);
                    gradient.addColorStop(0, '#FF9800');
                    gradient.addColorStop(1, this.options.primaryColor);

                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x, y, barWidth - 1, barHeight);
                }
            }

            drawGrid(width, height) {
                this.ctx.strokeStyle = this.options.gridColor;
                this.ctx.lineWidth = 0.5;
                this.ctx.beginPath();

                // æ°´å¹³çº¿
                for (let i = 1; i < 4; i++) {
                    const y = (height / 4) * i;
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(width, y);
                }

                // å‚ç›´çº¿
                for (let i = 1; i < 8; i++) {
                    const x = (width / 8) * i;
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, height);
                }

                this.ctx.stroke();
            }

            drawNoSignal(width, height, message) {
                this.ctx.fillStyle = '#999';
                this.ctx.font = '14px sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(message, width / 2, height / 2);
            }

            calculateVolume() {
                if (this.audioBuffer.length === 0) return -60;

                const rms = Math.sqrt(
                    this.audioBuffer.reduce((sum, sample) => sum + sample * sample, 0) / this.audioBuffer.length
                );

                return rms > 0 ? Math.max(-60, 20 * Math.log10(rms)) : -60;
            }
        }

        // æ¼”ç¤ºæ•°æ®ç”Ÿæˆå™¨
        class DemoDataGenerator {
            constructor() {
                this.isRunning = false;
                this.frame = 0;
                this.interval = null;
                this.sampleRate = 44100;
                this.bufferSize = 1024;
            }

            start(callback) {
                if (this.isRunning) return;

                this.isRunning = true;
                this.frame = 0;

                this.interval = setInterval(() => {
                    const inputData = this.generateInputAudio();
                    const outputData = this.generateOutputAudio();

                    callback(inputData, outputData);
                    this.frame++;
                }, 50); // 20 FPS
            }

            stop() {
                this.isRunning = false;
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }

            generateInputAudio() {
                const samples = [];
                for (let i = 0; i < this.bufferSize; i++) {
                    const t = (this.frame * this.bufferSize + i) / this.sampleRate;

                    // å¤åˆéŸ³é¢‘ä¿¡å·
                    const signal =
                        0.3 * Math.sin(2 * Math.PI * 440 * t) +  // A4
                        0.2 * Math.sin(2 * Math.PI * 880 * t) +  // A5
                        0.1 * Math.sin(2 * Math.PI * 220 * t) +  // A3
                        0.05 * (Math.random() - 0.5);           // å™ªå£°

                    samples.push(signal);
                }
                return samples;
            }

            generateOutputAudio() {
                const samples = [];
                for (let i = 0; i < this.bufferSize; i++) {
                    const t = (this.frame * this.bufferSize + i) / this.sampleRate;

                    // è½¬æ¢åçš„éŸ³é¢‘ä¿¡å·
                    const signal =
                        0.4 * Math.sin(2 * Math.PI * 523.25 * t) +  // C5
                        0.25 * Math.sin(2 * Math.PI * 659.25 * t) + // E5
                        0.15 * Math.sin(2 * Math.PI * 783.99 * t);  // G5

                    samples.push(signal);
                }
                return samples;
            }
        }

        // åº”ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆ›å»ºå¯è§†åŒ–å™¨
            const inputVisualizer = new AudioVisualizer('inputCanvas', {
                primaryColor: '#ff6b6b',
                backgroundColor: '#fff5f5'
            });

            const outputVisualizer = new AudioVisualizer('outputCanvas', {
                primaryColor: '#4ecdc4',
                backgroundColor: '#f0fffe'
            });

            // åˆ›å»ºæ¼”ç¤ºæ•°æ®ç”Ÿæˆå™¨
            const demoGenerator = new DemoDataGenerator();

            // çŠ¶æ€ç®¡ç†
            let isRunning = false;
            let frameCount = 0;
            let lastFpsTime = Date.now();

            // UI å…ƒç´ 
            const elements = {
                startDemo: document.getElementById('startDemo'),
                stopDemo: document.getElementById('stopDemo'),
                inputToggle: document.getElementById('inputToggle'),
                outputToggle: document.getElementById('outputToggle'),
                statusIndicator: document.getElementById('statusIndicator'),
                statusText: document.getElementById('statusText'),
                latencyText: document.getElementById('latencyText'),
                fpsText: document.getElementById('fpsText'),
                inputLevel: document.getElementById('inputLevel'),
                inputLevelText: document.getElementById('inputLevelText'),
                outputLevel: document.getElementById('outputLevel'),
                outputLevelText: document.getElementById('outputLevelText')
            };

            // è§†å›¾æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="inputView"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    inputVisualizer.setViewMode(e.target.value);
                });
            });

            document.querySelectorAll('input[name="outputView"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    outputVisualizer.setViewMode(e.target.value);
                });
            });

            // æ›´æ–°éŸ³é‡æ˜¾ç¤º
            function updateVolumeDisplay(visualizer, levelElement, textElement) {
                const volume = visualizer.calculateVolume();
                const percentage = Math.max(0, Math.min(100, (volume + 60) * 100 / 60));

                levelElement.style.width = percentage + '%';
                textElement.textContent = volume.toFixed(1) + 'dB';

                // é¢œè‰²æ ¹æ®éŸ³é‡è°ƒæ•´
                if (volume < -40) {
                    levelElement.style.backgroundColor = '#4CAF50';
                } else if (volume < -20) {
                    levelElement.style.backgroundColor = '#FF9800';
                } else {
                    levelElement.style.backgroundColor = '#F44336';
                }
            }

            // æ¼”ç¤ºå¼€å§‹
            function startDemo() {
                if (isRunning) return;

                isRunning = true;
                frameCount = 0;
                lastFpsTime = Date.now();

                elements.statusIndicator.classList.add('active');
                elements.statusText.textContent = 'æ¼”ç¤ºè¿è¡Œä¸­';
                elements.startDemo.disabled = true;

                demoGenerator.start((inputData, outputData) => {
                    inputVisualizer.updateAudioData(inputData);
                    outputVisualizer.updateAudioData(outputData);

                    // æ›´æ–°éŸ³é‡æ˜¾ç¤º
                    updateVolumeDisplay(inputVisualizer, elements.inputLevel, elements.inputLevelText);
                    updateVolumeDisplay(outputVisualizer, elements.outputLevel, elements.outputLevelText);

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    frameCount++;
                    const now = Date.now();
                    if (now - lastFpsTime >= 1000) {
                        elements.fpsText.textContent = frameCount + ' FPS';
                        frameCount = 0;
                        lastFpsTime = now;

                        // æ¨¡æ‹Ÿå»¶è¿Ÿ
                        const latency = 20 + Math.random() * 15;
                        elements.latencyText.textContent = Math.round(latency) + 'ms';
                    }
                });
            }

            // æ¼”ç¤ºåœæ­¢
            function stopDemo() {
                if (!isRunning) return;

                isRunning = false;
                demoGenerator.stop();

                elements.statusIndicator.classList.remove('active');
                elements.statusText.textContent = 'æ¼”ç¤ºå·²åœæ­¢';
                elements.startDemo.disabled = false;
                elements.fpsText.textContent = '0 FPS';
                elements.latencyText.textContent = '0ms';

                // é‡ç½®éŸ³é‡æ˜¾ç¤º
                elements.inputLevel.style.width = '0%';
                elements.inputLevelText.textContent = '-60.0dB';
                elements.outputLevel.style.width = '0%';
                elements.outputLevelText.textContent = '-60.0dB';
            }

            // äº‹ä»¶ç›‘å¬å™¨
            elements.startDemo.addEventListener('click', startDemo);
            elements.stopDemo.addEventListener('click', stopDemo);

            elements.inputToggle.addEventListener('click', () => {
                if (inputVisualizer.isActive) {
                    inputVisualizer.stop();
                    elements.inputToggle.textContent = 'å¼€å§‹';
                    elements.inputToggle.classList.remove('active');
                } else {
                    inputVisualizer.start();
                    elements.inputToggle.textContent = 'æš‚åœ';
                    elements.inputToggle.classList.add('active');
                }
            });

            elements.outputToggle.addEventListener('click', () => {
                if (outputVisualizer.isActive) {
                    outputVisualizer.stop();
                    elements.outputToggle.textContent = 'å¼€å§‹';
                    elements.outputToggle.classList.remove('active');
                } else {
                    outputVisualizer.start();
                    elements.outputToggle.textContent = 'æš‚åœ';
                    elements.outputToggle.classList.add('active');
                }
            });

            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                inputVisualizer.setupCanvas();
                outputVisualizer.setupCanvas();
            });

            // åˆå§‹çŠ¶æ€
            inputVisualizer.start();
            outputVisualizer.start();
            elements.inputToggle.textContent = 'æš‚åœ';
            elements.inputToggle.classList.add('active');
            elements.outputToggle.textContent = 'æš‚åœ';
            elements.outputToggle.classList.add('active');
        });
    </script>
</body>
</html>
